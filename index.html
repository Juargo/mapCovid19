<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>mapCovid19CL</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>

    <style>
        #contagiados {
            height: 100vh;
            width: 47vw;
            margin-right: 15px;
            float: left;
        }

        #cuarentenas {
            height: 100vh;
            width: 47vw;
        }
        #wrap_comunas {
            position: relative;
            display: inline-block;
        }
        #etiquetas {
            position: absolute;
            top: 67px;
            z-index: 10000;
            height: 0px;
            right: 0px;
            font-size: 8px;
            margin: 13px;
            color: black;
            font-family: sans-serif;
        }
        #etiquetas a {
            color: black;
            text-decoration: none;
            font-size: 11px;
        }
        #etiquetas a:hover {
            color: #c70000;
        }  
        .wrap_ppal {
            display: inline-block;
            vertical-align: top;
        }    
        #etiquetas h2 {
            background: hsla(0, 0%, 64%, 0.4);
            padding: 10px ! important;
            border-radius: 11px;
        }                
    </style>
</head>

<body>
    <div class="contenedor-mapas">
        <div id='wrap_contagiados' class="wrap_ppal">            
            <h1>Contagiados</h1>
            <div id="contagiados"></div>
        </div>
        <div id='wrap_comunas' class="wrap_ppal">            
            <h1>Comunas en cuarentena</h1>
            <div id="cuarentenas"></div>
            <div id="etiquetas"></div>
        </div>
    </div>
    <script>


        coordenadas = []
        coordenadas["Arica y Parinacota"] = { latitude: -18.728789, longitude: -69.897747 };
        coordenadas["Tarapacá"] = { latitude: -20.215031, longitude: -69.543372 };
        coordenadas["Antofagasta"] = { latitude: -23.648366, longitude: -70.394209 };
        coordenadas["Atacama"] = { latitude: -27.603692, longitude: -70.315332 };
        coordenadas["Coquimbo"] = { latitude: -29.967776, longitude: -71.329594 };
        coordenadas["Valparaíso"] = { latitude: -33.048674, longitude: -71.625816 };
        coordenadas["Metropolitana"] = { latitude: -33.414830, longitude: -70.662830 };
        coordenadas["O’Higgins"] = { latitude: -34.461338, longitude: -71.298434 };
        coordenadas["Maule"] = { latitude: -35.596401, longitude: -71.483462 };
        coordenadas["Ñuble"] = { latitude: -36.598112, longitude: -72.013757 };
        coordenadas["Biobío"] = { latitude: -36.849994, longitude: -73.023011 };
        coordenadas["Araucanía"] = { latitude: -38.659524, longitude: -72.541132 };
        coordenadas["Los Ríos"] = { latitude: -39.827413, longitude: -73.187970 };
        coordenadas["Los Lagos"] = { latitude: -41.470441, longitude: -72.947332 };
        coordenadas["Aysén"] = { latitude: -45.394099, longitude: -72.746076 };
        coordenadas["Magallanes"] = { latitude: -52.857106, longitude: -71.091946 };

        var contagiados = L.map('contagiados', {
            center: [-33.414830, -70.662830],
            zoom: 8
        });

        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
            maxZoom: 18
        }).addTo(contagiados);
        L.control.scale().addTo(contagiados);

        var radius = 0
        fetch('http://167.99.156.156:8080/getDataMinsal')
            .then(res => res.json())
            .then((out) => {
                console.log('Output: ', out);
                console.log(coordenadas);
                out.Data.Regiones.forEach(element => {
                    // console.log(element)
                    // console.log(coordenadas[element.Name]);
                    if (element.Name != "Total") {
                        if (element.Casostotales > 1200) {
                            radius = 1295
                        } else {
                            radius = element.Casostotales
                        }
                        var circle = L.circle([coordenadas[element.Name].latitude, coordenadas[element.Name].longitude], {
                            color: 'red',
                            fillColor: '#f03',
                            fillOpacity: 0.5,
                            radius: 30 * radius
                        }).addTo(contagiados);
                        // circle.bindPopup("<strong>" + element.Name + "</strong> <p>" + "Total Casos: " + element.Casostotales + "</p>");
                        circle.bindTooltip("<strong>" + element.Name + "</strong> <p>" + "<strong>Total Casos</strong>: " + element.Casostotales + "</p> <p><strong> Casos Nuevos</strong>: " + element.Casosnuevos + "</p>" + "</p> <p><strong> Fallecidos</strong>: " + element.Fallecidos + "</p>")
                    }
                });
            }).catch(err => console.error(err));

        //cuarentenas
        fetch('../mapajorge/infoMapa.php')
            .then(res => res.json())
            .then((res) => {
                procesaCuarentenas(res);
            }).catch(err => console.error(err));
        var cuarentenas;
        function procesaCuarentenas(datos) {
            cuarentenas = creaMapaCuarentena();
            var etiquetas = "<h2>Ver cuarentenas:<h2>";
            Object.keys(datos).forEach(function (item) {
                etiquetas += "<a href='javascript:void(0)' onClick='irA(event, \""+datos[item]["coordenadas"][0][0]+"\", \""+datos[item]["coordenadas"][0][1]+"\")'>"+datos[item]["nombre"]+"</a><br>";

                L.polygon(
                    datos[item]["coordenadas"],
                    { color: '#ae9f22' }
                )
                .bindTooltip("<strong>" + datos[item]["nombre"] + "</strong>")
                .addTo(cuarentenas);             
            }); 
            
            var element = document.querySelector("#etiquetas");
            element.innerHTML = etiquetas;

        }
        function creaMapaCuarentena() {
            var mapa = L.map('cuarentenas', {
                center: [-33.414830, -70.662830],
                zoom: 8
            });
            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
                maxZoom: 18
            }).addTo(mapa);
            L.control.scale().addTo(mapa);       
            return mapa;            
        }      
        function irA(e, lat, lng) {
            e.preventDefault();
            cuarentenas.setZoom(11, {animate: false});
            cuarentenas.panTo(new L.LatLng(lat, lng));
        }  

    </script>

</body>

</html>